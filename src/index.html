<!DOCTYPE html>
<head>
    <title>RedAgate Live Demo</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <style>
        html {
            height: 100%;
            margin: 0;
        }
        body {
            height: 100%;
            margin: 0;
            overflow: hidden;
            background-color: rgb(119, 11, 11);
            color: whitesmoke;
        }
        #preview-wrap {
            width: 100%;
            height: calc(100% - 100px);
            margin: 0;
        }
        #preview {
            flex-grow: 3;
            height: 100%;
            background-color: lightgrey;
        }
        #preview-src {
            flex-grow: 2;
            height: 100%;
            background-color: whitesmoke;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/superagent/3.8.2/superagent.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.5/require.min.js"></script>
    <script>
        require.config({
            paths: {
                app: 'app'
            }
        });

        function escapeHtml(s) {
            return s
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#39;");
        }

        function toggleCode() {
            var iframe = document.getElementById('preview-src');
            iframe.style.display = iframe.style.display === 'none' ? 'block' : 'none';
        }

        function renderReport(name, runPrint) {
            require(['app'], function(app) {
                var handler = app.barcodeTestHandler;
                var data = app.kanbanData;
                var src = '';

                switch (name) {
                case 'billing':
                    handler = app.billngReportHandler;
                    data = app.billngData;
                    src = 'https://raw.githubusercontent.com/shellyln/red-agate-live-demo/master/src/examples/billing.tsx';
                    break;
                case 'kanban':
                    handler = app.kanbanReportHandler;
                    data = app.kanbanData;
                    src = 'https://raw.githubusercontent.com/shellyln/red-agate-live-demo/master/src/examples/kanban.tsx';
                    break;
                case 'fba-a4':
                    handler = app.fbaA4ReportHandler;
                    data = app.kanbanData;
                    src = 'https://raw.githubusercontent.com/shellyln/red-agate-live-demo/master/src/examples/fba-a4.tsx';
                    break;
                case 'barcode-test':
                    handler = app.barcodeTestHandler;
                    data = app.kanbanData;
                    src = 'https://raw.githubusercontent.com/shellyln/red-agate-live-demo/master/src/examples/barcode-test.tsx';
                    break;
                }
                handler(data, {}, function(error, result) {
                    if (error) {
                        console.error(error);
                    } else {
                        var iframe = document.getElementById('preview');
                        if (runPrint) {
                            result = result.replace(/<\/body>\s*(<\/html>\s*)$/, '<script>window.print()<' + '/script></body>$1');
                        }
                        iframe.src = 'data:text/html;base64,' + btoa(unescape(encodeURIComponent(result)));
                    }
                });
                var request = window.superagent;
                request
                .get(src)
                .end(function(err, res){
                    if (res) {
                        var iframe = document.getElementById('preview-src');
                        iframe.src = 'data:text/html;base64,' + btoa(unescape(encodeURIComponent(
                            '<html><body>' +
                            '<link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono" rel="stylesheet">' +
                            '<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">' +
                            '<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"><' + '/script>' +
                            '<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/typescript.min.js"><' + '/script>' +
                            '<pre><code class="typescript" style="overflow: visible !important; font-family: \'Ubuntu Mono\', monospace;">' + escapeHtml(res.text.trim()) + '</code></pre>' +
                            '<script>hljs.initHighlightingOnLoad();<' + '/script>' +
                            '</body></html>'
                        )));
                    }
                });
            });
        }

        renderReport();
    </script>
</head>
<body>
    <div id="preview-wrap" style="display: flex;">
        <iframe id="preview"></iframe>
        <iframe id="preview-src" style="display: none;"></iframe>
    </div>
    <form style="margin: 10px;" name="configForm">
        <div style="display: flex;">
            <div><img src="https://shellyln.github.io/assets/image/redagate-logo.svg" style="width: 200px;"></div>
            <div style="margin-left: 20px;">
                <h3>RedAgate Live Demo</h3>
                <button type="button" class="btn btn-danger" onclick="renderReport('billing', document.configForm.doPrint.checked)">Billing</button>
                <button type="button" class="btn btn-danger" onclick="renderReport('kanban', document.configForm.doPrint.checked)">Kanban</button>
                <button type="button" class="btn btn-danger" onclick="renderReport('fba-a4', document.configForm.doPrint.checked)">FBA Label</button>
                <button type="button" class="btn btn-danger" onclick="renderReport('barcode-test', document.configForm.doPrint.checked)">Barcodes</button>
            </div>
            <div style="margin-left: 40px;">
                <div>
                    <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" name="showCode" onchange="toggleCode()">
                        <span>Show code</span>
                    </label>
                </div>
                <div>
                    <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" name="doPrint">
                        <span>Open print preview</span>
                    </label>
                </div>
            </div>
        </div>
    </form>
</body>